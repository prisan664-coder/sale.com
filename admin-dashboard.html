<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>

    <!-- Favicon -->
    <link rel="shortcut icon"
        href="https://scontent.fvte1-1.fna.fbcdn.net/v/t39.30808-6/518825433_122117695760900284_354744809560286503_n.jpg?_nc_cat=102&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=ldLnZ0tvy08Q7kNvwF7Ekl4&_nc_oc=AdlK_DvJpcucNDU2Pdijw4813aGABLoY7ukxzNCEhUUr9pakpwxVacXzJ08x8kQOfjg&_nc_zt=23&_nc_ht=scontent.fvte1-1.fna&_nc_gid=KGJcV5nwnpkb1syQENv5mQ&oh=00_AfjzcdNWomaPDeeWsmN0eF0-HLhLzbRNM8xBxCv2OuroFQ&oe=692D81D6"
        type="image/x-icon">
    <link rel="icon"
        href="https://scontent.fvte1-1.fna.fbcdn.net/v/t39.30808-6/518825433_122117695760900284_354744809560286503_n.jpg?_nc_cat=102&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=ldLnZ0tvy08Q7kNvwF7Ekl4&_nc_oc=AdlK_DvJpcucNDU2Pdijw4813aGABLoY7ukxzNCEhUUr9pakpwxVacXzJ08x8kQOfjg&_nc_zt=23&_nc_ht=scontent.fvte1-1.fna&_nc_gid=KGJcV5nwnpkb1syQENv5mQ&oh=00_AfjzcdNWomaPDeeWsmN0eF0-HLhLzbRNM8xBxCv2OuroFQ&oe=692D81D6"
        type="image/x-icon">

    <script type="application/ld+json"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-img-top {
            height: 150px;
            object-fit: cover;
        }

        .tracking-card {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .tracking-card h5 {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tracking-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .tracking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .tracking-item button {
            font-size: 0.8rem;
        }
    </style>
</head>

<body class="bg-light">

    <div class="container py-4">
        <h2 class="mb-4 text-primary">Admin Dashboard</h2>
        <a class="btn btn-secondary mb-3" href="index.html">กลับหน้าเว็บ</a>
         <a class="btn btn-secondary mb-3" href="Admin2.html">แอดมินดูแลออเดอร์</a>

        <!-- Category Selection -->
        <div class="mb-3">
            <label class="form-label fw-bold">เลือกหมวดหมู่สินค้า:</label>
            <select id="categorySelect" class="form-select w-auto d-inline">
                <option value="cases">ໂທລະສັບໄອໂຟນສະເພາະມື 1</option>
                <option value="cables">ໂທລະສັບແອນດລອຍມື 1</option>
                <option value="phones">ໂທລະສັບມືສອງ
                </option>
                <option value="welcome-products">ສິນຄ້າທົ່ວໄປ</option>
            </select>
            <button class="btn btn-success" id="addProductBtn">เพิ่มสินค้า</button>
        </div>

        <!-- Product Management -->
        <div class="row mb-4" id="productsContainer"></div>

        <!-- Visitors Table -->
        <h4>ผู้เข้าชมเว็บไซต์</h4>
        <table class="table table-striped" id="visitorsTable">
            <thead>
                <tr>
                    <th>IP</th>
                    <th>Device</th>
                    <th>เวลาเข้าชม</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- Customer Tracking -->
        <div class="tracking-card">
            <h5>
                ติดตามพฤติกรรมลูกค้า
                <button class="btn btn-sm btn-danger" id="deleteAllTrackingBtn">ลบทั้งหมด</button>
            </h5>
            <div class="tracking-list" id="trackingList"></div>
        </div>

    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getDatabase, ref as dbRef, onValue, push, remove, update, onChildAdded } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

        const allowedAdmins = ["admin@fujimobile.com"];
        const currentAdmin = sessionStorage.getItem('adminEmail');
        if (!currentAdmin || !allowedAdmins.includes(currentAdmin)) {
            alert('คุณยังไม่เข้าสู่ระบบ');
            window.location.href = 'admin.html';
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCLXIs8EaJNauHJpcnDMKU99C-uBKKR0aU",
            authDomain: "my-bank-87108.firebaseapp.com",
            databaseURL: "https://my-bank-87108-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "my-bank-87108",
            storageBucket: "my-bank-87108.appspot.com",
            messagingSenderId: "692654082797",
            appId: "1:692654082797:web:3b5f9912900a8cb5409ae4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const productsContainer = document.getElementById('productsContainer');
        const categorySelect = document.getElementById('categorySelect');
        const visitorsTable = document.getElementById('visitorsTable').querySelector('tbody');
        const trackingList = document.getElementById('trackingList');
        const deleteAllTrackingBtn = document.getElementById('deleteAllTrackingBtn');

        // Products
        function renderProducts(category) {
            onValue(dbRef(db, 'products/' + category), snapshot => {
                const data = snapshot.val() || {};
                productsContainer.innerHTML = '';
                Object.keys(data).forEach(key => {
                    const p = data[key];
                    const col = document.createElement('div');
                    col.className = 'col-md-3 mb-3';
                    col.innerHTML = `
                        <div class="card h-100">
                            <img src="${p.imageUrl}" class="card-img-top" alt="${p.name}">
                            <div class="card-body">
                                <h5 class="card-title">${p.name}</h5>
                                <p class="card-text">ราคา: ${p.price}</p>
                                <p class="card-text">${p.description}</p>
                                <button class="btn btn-sm btn-warning edit-btn" data-key="${key}">แก้ไข</button>
                                <button class="btn btn-sm btn-danger delete-btn" data-key="${key}">ลบ</button>
                            </div>
                        </div>
                    `;
                    productsContainer.appendChild(col);
                });

                productsContainer.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const key = btn.dataset.key;
                        const p = data[key];
                        const name = prompt('ชื่อสินค้า', p.name); if (!name) return;
                        const price = prompt('ราคา', p.price); if (!price) return;
                        const desc = prompt('รายละเอียด', p.description); if (!desc) return;
                        const imageUrl = prompt('URL รูป', p.imageUrl); if (!imageUrl) return;
                        update(dbRef(db, 'products/' + category + '/' + key), { name, price, description: desc, imageUrl });
                    });
                });

                productsContainer.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const key = btn.dataset.key;
                        if (confirm('คุณต้องการลบสินค้านี้หรือไม่?')) {
                            remove(dbRef(db, 'products/' + category + '/' + key));
                        }
                    });
                });
            });
        }

        document.getElementById('addProductBtn').addEventListener('click', () => {
            const category = categorySelect.value;
            const name = prompt('ชื่อสินค้า'); if (!name) return;
            const price = prompt('ราคา'); if (!price) return;
            const description = prompt('รายละเอียด'); if (!description) return;
            const imageUrl = prompt('URL รูป'); if (!imageUrl) return;
            push(dbRef(db, 'products/' + category), { name, price, description, imageUrl });
        });

        renderProducts(categorySelect.value);
        categorySelect.addEventListener('change', () => renderProducts(categorySelect.value));

        // render visitors
        onValue(dbRef(db, 'visitors'), snapshot => {
            const data = snapshot.val() || {};
            visitorsTable.innerHTML = '';
            Object.values(data).forEach(v => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${v.ip}</td><td>${v.device}</td><td>${new Date(v.time).toLocaleString('th-TH')}</td>`;
                visitorsTable.appendChild(tr);
            });
        });

        // render customer tracking with delete
        onChildAdded(dbRef(db, 'analytics'), snapshot => {
            const category = snapshot.key;
            const catRef = dbRef(db, 'analytics/' + category);
            onChildAdded(catRef, childSnap => {
                const key = childSnap.key;
                const data = childSnap.val();

                const div = document.createElement('div');
                div.className = 'tracking-item';
                div.innerHTML = `
                    <span>${new Date(data.timestamp).toLocaleString()} - ${category}: ${JSON.stringify(data)}</span>
                    <button class="btn btn-sm btn-danger">ลบ</button>
                `;

                div.querySelector('button').addEventListener('click', () => {
                    if (confirm('คุณต้องการลบรายการนี้หรือไม่?')) {
                        remove(dbRef(db, 'analytics/' + category + '/' + key));
                        div.remove();
                    }
                });

                trackingList.prepend(div);
            });
        });

        // delete all tracking
        deleteAllTrackingBtn.addEventListener('click', () => {
            if (confirm('คุณต้องการลบรายการทั้งหมดหรือไม่?')) {
                remove(dbRef(db, 'analytics'));
                trackingList.innerHTML = '';
            }
        });

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
